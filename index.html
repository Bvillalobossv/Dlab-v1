<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RaiZen ¬∑ Dlab-v1</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

  <!-- ============== INTRO ============== -->
  <div id="screenIntro" class="screen active">
    <div class="carousel-shell">
      <div class="slides" id="introSlides">
        <section class="slide">
          <div class="slide-text">
            <h2>Bienvenido a RaiZen</h2>
            <p>Un check-in breve para entender tu bienestar hoy.</p>
          </div>
        </section>
        <section class="slide">
          <div class="slide-text">
            <h2>Privacidad</h2>
            <p>Procesamos c√°mara y micr√≥fono en tu dispositivo. Guardamos resultados, no crudos.</p>
          </div>
        </section>
        <section class="slide">
          <div class="slide-text">
            <h2>R√°pido</h2>
            <p>En minutos tendr√°s un informe y un consejo accionable.</p>
          </div>
        </section>
      </div>
      <div class="dots" id="introDots"></div>
      <div class="stack-sm">
        <button id="introPrev" class="btn btn-secondary">Anterior</button>
        <button id="introNext" class="btn">Siguiente</button>
        <button id="introStart" class="btn" style="display:none">¬°Comenzar!</button>
      </div>
    </div>
  </div>

  <!-- ============== AUTH ============== -->
  <div id="screenAuth" class="screen">
    <img src="./images/logo.png" alt="" class="logo" onerror="this.style.display='none'"/>
    <h1>RaiZen</h1>
    <p class="lead">Inicia sesi√≥n o crea tu cuenta.</p>

    <div class="card max-600">
      <div class="segmented">
        <button id="authTabLogin" class="segment active">Iniciar sesi√≥n</button>
        <button id="authTabSignup" class="segment">Crear cuenta</button>
      </div>

      <form id="formLogin" class="form" novalidate>
        <div class="form-row">
          <label>Usuario</label>
          <input type="text" id="login_user" autocomplete="username" required />
        </div>
        <div class="form-row">
          <label>Contrase√±a</label>
          <input type="password" id="login_pass" autocomplete="current-password" required />
        </div>
        <button type="submit" class="btn">Entrar</button>
      </form>

      <form id="formSignup" class="form" style="display:none" novalidate>
        <div class="form-row">
          <label>Nuevo usuario</label>
          <input type="text" id="su_user" autocomplete="username" required />
        </div>
        <div class="form-row">
          <label>Contrase√±a (m√≠nimo 6)</label>
          <input type="password" id="su_pass" autocomplete="new-password" minlength="6" required />
        </div>
        <div class="form-row chk">
          <label>
            <input type="checkbox" id="su_terms" required />
            Acepto los <a href="#" id="view-terms-link">T√©rminos</a>
          </label>
        </div>
        <button type="submit" class="btn">Crear cuenta</button>
      </form>

      <p id="auth-message" class="muted small"></p>
    </div>
  </div>

  <!-- ============== T√âRMINOS ============== -->
  <div id="screenTerms" class="screen">
    <div class="card max-700 text-left">
      <h2>T√©rminos</h2>
      <p>RaiZen no es diagn√≥stico m√©dico. Procesamos en local y guardamos m√©tricas agregadas.</p>
      <button id="close-terms-button" class="btn">Entendido</button>
    </div>
  </div>

  <!-- ============== HOME ============== -->
  <div id="screenHome" class="screen">
    <div class="card max-700">
      <h2 id="welcome-user">¬°Hola!</h2>
      <p class="lead">¬øListo para tu check-in?</p>
      <button id="btnHomeStart" class="btn">Comenzar</button>
      <hr class="divider">
      <button id="btnSignOut" class="btn btn-secondary">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <!-- ============== PASO 1: AN√ÅLISIS FACIAL ============== -->
  <div id="screenFace" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 1 de 6</span>
      <h2>An√°lisis Facial</h2>
      <p class="lead">Una selfie para empezar el d√≠a.</p>
    </div>

    <div class="card max-900">
      <div class="two-cols">
        <div>
          <video id="faceVideo" playsinline muted class="video"></video>
          <canvas id="faceCanvas" class="video" style="display:none"></canvas>
          <div class="stack-sm">
            <button id="btnFaceStart" class="btn">üì∏ Activar c√°mara</button>
            <button id="btnFaceSnap" class="btn btn-outline" disabled>Analizar mi expresi√≥n</button>
          </div>
          <p id="faceHelp" class="muted small">
            iPhone/Safari: usa HTTPS. Si no ves el di√°logo de permiso, t√≥calo de nuevo.
          </p>
        </div>

        <div class="results-container">
          <h3>Resultado</h3>
          <p class="muted small">(aparecer√° tras analizar)</p>
          <div id="face-results-content" class="hidden">
            <p><b>Emoci√≥n:</b> <span id="faceEmotion">‚Äî</span></p>
            <p><b>Confianza:</b> <span id="faceConfidence">‚Äî</span></p>
            <img id="faceMascot" class="mascot" alt="Mascota emoci√≥n" />
            <p id="faceTip" class="muted"></p>
          </div>
        </div>
      </div>
    </div>

    <div class="navigation-buttons">
      <button id="btnFaceNext" class="btn" disabled>Siguiente</button>
      <button id="btnFaceSkip" class="btn btn-secondary">Saltar</button>
    </div>
  </div>

  <!-- ============== PASO 2: PREP AUDIO ============== -->
  <div id="screenAudioPrep" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 2 de 6</span>
      <h2>Preparar medici√≥n ac√∫stica</h2>
      <p class="lead">Permite el micr√≥fono y busca un lugar estable.</p>
    </div>
    <div class="card max-700">
      <ul class="tips">
        <li>Mant√©n el m√≥vil quieto.</li>
        <li>No cubras el micr√≥fono.</li>
        <li>Cuando aparezca, acepta el permiso.</li>
      </ul>
      <p id="audio-permission-msg" class="muted">Pulsa ‚ÄúProbar micr√≥fono‚Äù.</p>
      <button id="btnTestMic" class="btn">üé§ Probar micr√≥fono</button>
      <p id="audio-permission-result" class="small"></p>
    </div>
    <div class="navigation-buttons">
      <button id="btnGoToMeasure" class="btn" disabled>Continuar</button>
    </div>
  </div>

  <!-- ============== PASO 3: AMBIENTE AC√öSTICO ============== -->
  <div id="screenMeasure" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 3 de 6</span>
      <h2>Ambiente ac√∫stico</h2>
      <p class="lead">Mediremos durante 5 segundos y calcularemos el promedio.</p>
    </div>

    <div class="card max-900">
      <!-- Veloc√≠metro -->
      <div class="gauge-wrapper">
        <canvas id="gaugeChart" width="280" height="280"></canvas>
        <div class="gauge-center">
          <span id="dbValue" class="db-value">0</span>
          <span class="db-unit">dB</span>
          <div id="dbLabel" class="db-label"></div>
          <div id="countdown" class="countdown">5.0 s</div>
        </div>
      </div>
      <p id="status" class="muted">Pulsa ‚ÄúIniciar 5s‚Äù.</p>
      <button id="toggleBtn" class="btn">üéôÔ∏è Iniciar 5s</button>
    </div>

    <div id="noise-results-card" class="card max-900 hidden">
      <h3>Resultados</h3>
      <p>Promedio: <b id="final-db-result">-- dB</b> ‚Äî <b id="final-db-label">--</b></p>
      <canvas id="noiseHistory" height="120"></canvas>

      <!-- Indicadores (clicables) -->
      <div class="ref-carousel" id="refCarousel">
        <button class="ref-card" data-key="saludable">
          <img src="./images/ind-saludable.png" alt="Ambiente saludable">
          <div>
            <h4>Ambiente saludable</h4>
            <p>&lt; 45 dB ‚Äî Librer√≠a / hogar silencioso.</p>
          </div>
        </button>
        <button class="ref-card" data-key="oficina">
          <img src="./images/ind-conversacion.png" alt="Oficina activa">
          <div>
            <h4>Oficina activa</h4>
            <p>45‚Äì65 dB ‚Äî Conversaci√≥n normal / oficina.</p>
          </div>
        </button>
        <button class="ref-card" data-key="ruidoso">
          <img src="./images/ind-ruido.png" alt="Ruidoso">
          <div>
            <h4>Ruidoso</h4>
            <p>65‚Äì80 dB ‚Äî Tr√°nsito, cafeter√≠a concurrida.</p>
          </div>
        </button>
        <button class="ref-card" data-key="muyruidoso">
          <img src="./images/ind-silencio.png" alt="Muy ruidoso">
          <div>
            <h4>Muy ruidoso</h4>
            <p>&gt; 80 dB ‚Äî Taller, construcci√≥n.</p>
          </div>
        </button>
      </div>
    </div>

    <div class="navigation-buttons">
      <button id="btnMeasureNext" class="btn" disabled>Siguiente</button>
    </div>
  </div>

  <!-- MODAL de indicadores -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <button id="modalClose" class="modal-close" aria-label="Cerrar">‚úï</button>
      <img id="modalImg" class="modal-img" alt="">
      <h3 id="modalTitle"></h3>
      <p id="modalBody" class="text-left"></p>
    </div>
  </div>

  <!-- ============== PASO 4: ESCANEO SOM√ÅTICO (3 zonas) ============== -->
  <div id="screenBodyScan" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 4 de 6</span>
      <h2>Escaneo corporal</h2>
      <p class="lead">Eval√∫a la tensi√≥n en tu cuerpo (1 = relajado, 10 = tensi√≥n alta).</p>
    </div>

    <div class="card max-900">
      <div class="grid-2">
        <div class="slider-block">
          <label>Cuello / Hombros</label>
          <input type="range" id="bs_head" min="1" max="10" value="1">
        </div>
        <div class="slider-block">
          <label>Espalda / T√≥rax</label>
          <input type="range" id="bs_upper" min="1" max="10" value="1">
        </div>
      </div>
      <div class="slider-block">
        <label>Piernas / Pies</label>
        <input type="range" id="bs_lower" min="1" max="10" value="1">
      </div>
      <p id="bs_tip" class="muted small">Consejo: suelta hombros y respira 3 veces lentamente.</p>
    </div>

    <div class="navigation-buttons">
      <button id="btnBodyScanNext" class="btn">Siguiente</button>
    </div>
  </div>

  <!-- ============== PASO 5: CONTEXTO ============== -->
  <div id="screenContext" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 5 de 6</span>
      <h2>Encuesta breve de contexto</h2>
      <p class="lead">√Årea/puesto y carga actual.</p>
    </div>

    <form id="contextForm" class="card max-900 text-left">
      <div class="grid-2">
        <div>
          <label>Fecha y hora</label>
          <input type="datetime-local" id="ctx_datetime">
        </div>
        <div>
          <label>√Årea / Puesto</label>
          <select id="ctx_area">
            <option>Ventas</option><option>Administraci√≥n</option><option>Finanzas</option>
            <option>TI</option><option>Marketing</option><option>Operaciones</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Horas trabajadas</label>
          <input type="number" id="ctx_hours" placeholder="Ej: 6" min="0" max="16">
        </div>
        <div></div>
      </div>
      <div class="slider-block"><label>Carga de trabajo hoy</label><input type="range" id="ctx_load" min="1" max="10" value="5"></div>
      <div class="slider-block"><label>Ritmo de trabajo</label><input type="range" id="ctx_pace" min="1" max="10" value="5"></div>
      <div class="slider-block"><label>Estr√©s general</label><input type="range" id="ctx_stress" min="1" max="10" value="5"></div>
    </form>

    <div class="navigation-buttons">
      <button id="btnContextNext" class="btn">Siguiente</button>
    </div>
  </div>

  <!-- ============== PASO 6: JOURNAL ============== -->
  <div id="screenJournal" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 6 de 6</span>
      <h2>Tu espacio</h2>
      <p class="lead">Opcional: comparte contexto de tu d√≠a.</p>
    </div>
    <div class="card max-700">
      <form id="journalForm">
        <textarea id="journal-input" placeholder="(Opcional) Comentario breve‚Ä¶"></textarea>
      </form>
    </div>
    <div class="navigation-buttons">
      <button id="btnJournalNext" class="btn">Finalizar y ver informe</button>
    </div>
  </div>

  <!-- ============== INFORME ============== -->
  <div id="screenIntegration" class="screen">
    <div class="step-header">
      <h2>Tu Informe de Bienestar</h2>
      <p class="lead">Resumen del check-in.</p>
    </div>
    <div class="card max-900 report-card">
      <div class="report-header">
        <div id="ix_score_circle" class="score-circle-large">--</div>
        <div class="report-title">
          <h3 id="ix_label">Calculando‚Ä¶</h3>
          <p>√çndice de equilibrio</p>
        </div>
      </div>
      <div class="report-breakdown">
        <h4>Desglose</h4>
        <div class="progress-item"><span class="progress-label">Estado an√≠mico</span><div class="progress-bar"><div id="ix_face_progress" class="progress-bar-fill"></div></div></div>
        <div class="progress-item"><span class="progress-label">Ambiente ac√∫stico</span><div class="progress-bar"><div id="ix_db_progress" class="progress-bar-fill"></div></div></div>
        <div class="progress-item"><span class="progress-label">Cuerpo (som√°tico)</span><div class="progress-bar"><div id="ix_bs_progress" class="progress-bar-fill"></div></div></div>
      </div>
      <div class="report-recommendation">
        <h4>Consejo del d√≠a</h4>
        <p id="ix_reco" class="muted">Analizando‚Ä¶</p>
      </div>
    </div>
    <div class="navigation-buttons">
      <button id="btnIntegrationHome" class="btn">Nuevo check-in</button>
    </div>
  </div>

  <script src="./app.js"></script>
</body>
</html>
