<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RaiZen</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

  <!-- ====================== ONBOARDING ====================== -->
  <div id="screenIntro" class="screen active">
    <div class="carousel-shell">
      <div class="slides" id="introSlides">
        <section class="slide">
          <img src="https://i.imgur.com/8a5g8G3.png" alt="Bienestar en el trabajo" class="slide-image"/>
          <div class="slide-text">
            <h2>Bienvenido a RaiZen</h2>
            <p>Tu espacio para conectar con tu bienestar laboral y encontrar el equilibrio, d√≠a a d√≠a.</p>
          </div>
        </section>
        <section class="slide">
          <img src="https://i.imgur.com/sL3b5x2.png" alt="Privacidad" class="slide-image"/>
          <div class="slide-text">
            <h2>Tu Privacidad es Sagrada</h2>
            <p>Procesamos c√°mara y micr√≥fono en tu dispositivo. Guardamos solo resultados.</p>
          </div>
        </section>
        <section class="slide">
          <img src="https://i.imgur.com/yXF8AFs.png" alt="An√°lisis r√°pido" class="slide-image"/>
          <div class="slide-text">
            <h2>Un Check-in en Minutos</h2>
            <p>En 4 pasos tendr√°s una visi√≥n clara de tu estado actual.</p>
          </div>
        </section>
      </div>
      <div class="dots" id="introDots"></div>
      <div class="stack-sm">
        <button id="introPrev" class="btn btn-secondary">Anterior</button>
        <button id="introNext" class="btn">Siguiente</button>
        <button id="introStart" class="btn" style="display:none">¬°Comenzar!</button>
      </div>
    </div>
  </div>

  <!-- ====================== AUTH ====================== -->
  <div id="screenAuth" class="screen">
    <img src="https://i.imgur.com/dJ88p2F.png" alt="Logo RaiZen" class="logo" />
    <h1>RaiZen</h1>
    <p class="lead">Inicia tu camino hacia el equilibrio.</p>

    <div class="card max-600">
      <div class="segmented">
        <button id="authTabLogin" class="segment active">Iniciar sesi√≥n</button>
        <button id="authTabSignup" class="segment">Crear cuenta</button>
      </div>

      <form id="formLogin" class="form" novalidate>
        <div class="form-row">
          <label>Usuario</label>
          <input type="text" id="login_user" autocomplete="username" required />
        </div>
        <div class="form-row">
          <label>Contrase√±a</label>
          <input type="password" id="login_pass" autocomplete="current-password" required />
        </div>
        <button type="submit" class="btn">Entrar</button>
      </form>

      <form id="formSignup" class="form" style="display:none" novalidate>
        <div class="form-row">
          <label>Nuevo usuario</label>
          <input type="text" id="su_user" autocomplete="username" required />
        </div>
        <div class="form-row">
          <label>Contrase√±a (m√≠nimo 6 caracteres)</label>
          <input type="password" id="su_pass" autocomplete="new-password" minlength="6" required />
        </div>
        <div class="form-row chk">
          <label>
            <input type="checkbox" id="su_terms" required />
            He le√≠do y acepto los <a href="#" id="view-terms-link">T√©rminos y Condiciones</a>
          </label>
        </div>
        <button type="submit" class="btn">Crear cuenta</button>
      </form>

      <p id="auth-message" class="muted small"></p>
    </div>
  </div>

  <!-- ====================== T√âRMINOS ====================== -->
  <div id="screenTerms" class="screen">
    <div class="card max-700 text-left">
      <h2>T√©rminos y Condiciones de RaiZen</h2>
      <p><strong>√öltima actualizaci√≥n: 14 de Octubre, 2025</strong></p>
      <p>RaiZen ayuda a monitorear tu bienestar laboral. No es un diagn√≥stico m√©dico.</p>
      <p>Los an√°lisis de c√°mara y micr√≥fono se procesan en tu dispositivo. Guardamos resultados agregados y tu comentario opcional.</p>
      <button id="close-terms-button" class="btn">Entendido</button>
    </div>
  </div>

  <!-- ====================== HOME ====================== -->
  <div id="screenHome" class="screen">
    <div class="card max-700">
      <img src="https://i.imgur.com/dJ88p2F.png" alt="Logo RaiZen" class="logo" />
      <h2 id="welcome-user">¬°Hola!</h2>
      <p class="lead">¬øListo para hacer tu check-in de bienestar de hoy?</p>
      <button id="btnHomeStart" class="btn">Comenzar Nuevo Check-in</button>
      <hr class="divider">
      <button id="btnSignOut" class="btn btn-secondary">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <!-- ====================== PASO 1: SELFIE (EMOCIONES) ====================== -->
  <div id="screenFace" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 1 de 5</span>
      <h2>An√°lisis Facial</h2>
      <p class="lead">Una selfie para empezar el d√≠a. Tu rostro nos da pistas sobre tu estado de √°nimo.</p>
    </div>
    <div class="card max-900">
      <div class="two-cols">
        <div>
          <video id="faceVideo" playsinline muted class="video"></video>
          <canvas id="faceCanvas" class="video" style="display:none"></canvas>
          <div class="stack-sm">
            <button id="btnFaceStart" class="btn">üì∏ Activar c√°mara</button>
            <button id="btnFaceSnap" class="btn btn-outline" disabled>Analizar mi expresi√≥n</button>
          </div>
          <p id="faceHelp" class="muted small">En iPhone abre por HTTPS y permite la c√°mara. Si no aparece el di√°logo, vuelve a tocar el bot√≥n.</p>
        </div>
        <div class="results-container">
          <h3>Tu Resultado Emocional</h3>
          <p class="muted small">(Tras analizar ver√°s tu emoci√≥n dominante)</p>
          <div id="face-results-content" class="hidden">
            <p><b>Emoci√≥n dominante:</b> <span id="faceEmotion">‚Äî</span></p>
            <p><b>Confianza:</b> <span id="faceConfidence">‚Äî</span></p>
            <img id="faceMascot" class="mascot" alt="Mascota emoci√≥n" />
            <p id="faceTip" class="muted"></p>
          </div>
        </div>
      </div>
    </div>
    <div class="navigation-buttons">
      <button id="btnFaceNext" class="btn" disabled>Siguiente Paso</button>
      <button id="btnFaceSkip" class="btn btn-secondary">Saltar</button>
    </div>
  </div>

  <!-- ====================== PASO 2: PREPARACI√ìN AUDIO ====================== -->
  <div id="screenAudioPrep" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 2 de 5</span>
      <h2>Preparar medici√≥n ac√∫stica</h2>
      <p class="lead">Busca un lugar estable, permite acceso al micr√≥fono y continuamos.</p>
    </div>
    <div class="card max-700">
      <ul class="tips">
        <li>Mant√©n el m√≥vil quieto sobre la mesa.</li>
        <li>Evita cubrir el micr√≥fono.</li>
        <li>Permite el acceso al micr√≥fono cuando te lo solicite el navegador.</li>
      </ul>
      <p id="audio-permission-msg" class="muted">Pulsa ‚ÄúProbar micr√≥fono‚Äù.</p>
      <button id="btnTestMic" class="btn">üé§ Probar micr√≥fono</button>
      <p id="audio-permission-result" class="small"></p>
    </div>
    <div class="navigation-buttons">
      <button id="btnGoToMeasure" class="btn" disabled>Continuar a medici√≥n</button>
    </div>
  </div>

  <!-- ====================== PASO 3: AMBIENTE AC√öSTICO ====================== -->
  <div id="screenMeasure" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 3 de 5</span>
      <h2>Ambiente ac√∫stico</h2>
      <p class="lead">Mediremos el nivel de ruido durante 5 segundos.</p>
    </div>

    <div class="card max-900">
      <!-- Veloc√≠metro -->
      <div class="gauge-wrapper">
        <canvas id="gaugeChart" width="280" height="280"></canvas>
        <div class="gauge-center">
          <span id="dbValue" class="db-value">0</span>
          <span class="db-unit">dB</span>
          <div id="dbLabel" class="db-label"></div>
          <div id="countdown" class="countdown">5.0 s</div>
        </div>
      </div>
      <p id="status" class="muted">Presiona "Iniciar 5s" para comenzar la medici√≥n.</p>
      <button id="toggleBtn" class="btn">üéôÔ∏è Iniciar 5s</button>
    </div>

    <!-- Resultados + gr√°fico -->
    <div id="noise-results-card" class="card max-900 hidden">
      <h3>Resultados</h3>
      <p>Promedio: <b id="final-db-result">-- dB</b> ‚Äî <b id="final-db-label">--</b></p>
      <canvas id="noiseHistory" height="120"></canvas>

      <!-- Carrusel de referencia -->
      <div class="ref-carousel" id="refCarousel">
        <div class="ref-card">
          <img src="images/ind-saludable.png" alt="Ambiente saludable">
          <div>
            <h4>Ambiente saludable</h4>
            <p>&lt; 45 dB ‚Äî Librer√≠a / hogar silencioso.</p>
          </div>
        </div>
        <div class="ref-card">
          <img src="images/ind-oficina.png" alt="Oficina activa">
          <div>
            <h4>Oficina activa</h4>
            <p>45‚Äì65 dB ‚Äî Conversaci√≥n normal / oficina.</p>
          </div>
        </div>
        <div class="ref-card">
          <img src="images/ind-conversacion.png" alt="Ruidoso">
          <div>
            <h4>Ruidoso</h4>
            <p>65‚Äì80 dB ‚Äî Tr√°nsito, cafeter√≠a concurrida.</p>
          </div>
        </div>
        <div class="ref-card">
          <img src="images/ind-silencio.png" alt="Muy ruidoso">
          <div>
            <h4>Muy ruidoso</h4>
            <p>&gt; 80 dB ‚Äî Taller, construcci√≥n.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="navigation-buttons">
      <button id="btnMeasureNext" class="btn" disabled>Siguiente Paso</button>
    </div>
  </div>

  <!-- ====================== PASO 4: ENCUESTA CONTEXTO ====================== -->
  <div id="screenContext" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 4 de 5</span>
      <h2>Encuesta breve de contexto</h2>
      <p class="lead">Nos ayuda a entender mejor tu jornada y tu √°rea de trabajo.</p>
    </div>

    <form id="contextForm" class="card max-900 text-left">
      <div class="grid-2">
        <div>
          <label>Fecha y hora</label>
          <input type="datetime-local" id="ctx_datetime">
        </div>
        <div>
          <label>√Årea / Puesto</label>
          <select id="ctx_area">
            <option>Ventas</option><option>Administraci√≥n</option><option>Finanzas</option>
            <option>TI</option><option>Marketing</option><option>Operaciones</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Horas trabajadas</label>
          <input type="number" id="ctx_hours" placeholder="Ej: 6" min="0" max="16">
        </div>
        <div></div>
      </div>

      <div class="slider-block">
        <label>Carga de trabajo hoy</label>
        <input type="range" id="ctx_load" min="1" max="10" value="5">
      </div>
      <div class="slider-block">
        <label>Ritmo de trabajo</label>
        <input type="range" id="ctx_pace" min="1" max="10" value="5">
      </div>
      <div class="slider-block">
        <label>Estr√©s general</label>
        <input type="range" id="ctx_stress" min="1" max="10" value="5">
      </div>
    </form>

    <div class="navigation-buttons">
      <button id="btnContextNext" class="btn">Siguiente Paso</button>
    </div>
  </div>

  <!-- ====================== PASO 5: JOURNAL ====================== -->
  <div id="screenJournal" class="screen">
    <div class="step-header">
      <span class="step-counter">Paso 5 de 5</span>
      <h2>Tu Espacio</h2>
      <p class="lead">¬øAlgo m√°s en tu mente hoy? (Opcional)</p>
    </div>
    <div class="card max-700">
      <form id="journalForm">
        <textarea id="journal-input" placeholder="(Opcional) Comparte un contexto breve de tu d√≠a..."></textarea>
        <p class="muted small">Este comentario ser√° confidencial.</p>
      </form>
    </div>
    <div class="navigation-buttons">
      <button id="btnJournalNext" class="btn">Finalizar y Ver Informe</button>
    </div>
  </div>

  <!-- ====================== INFORME ====================== -->
  <div id="screenIntegration" class="screen">
    <div class="step-header">
      <h2>Tu Informe de Bienestar</h2>
      <p class="lead">Resumen de tu check-in de hoy.</p>
    </div>
    <div class="card max-900 report-card">
      <div class="report-header">
        <div id="ix_score_circle" class="score-circle-large">--</div>
        <div class="report-title">
          <h3 id="ix_label">Calculando...</h3>
          <p>Tu √çndice de Equilibrio</p>
        </div>
      </div>
      <div class="report-breakdown">
        <h4>Desglose:</h4>
        <div class="progress-item"><span class="progress-label">Estado An√≠mico</span><div class="progress-bar"><div id="ix_face_progress" class="progress-bar-fill"></div></div></div>
        <div class="progress-item"><span class="progress-label">Ambiente Ac√∫stico</span><div class="progress-bar"><div id="ix_db_progress" class="progress-bar-fill"></div></div></div>
        <div class="progress-item"><span class="progress-label">Tensi√≥n Corporal</span><div class="progress-bar"><div id="ix_bs_progress" class="progress-bar-fill"></div></div></div>
      </div>
      <div class="report-recommendation">
        <h4>Consejo del D√≠a</h4>
        <p id="ix_reco" class="muted">Analizando resultados...</p>
      </div>
    </div>
    <div class="navigation-buttons">
      <button id="btnIntegrationHome" class="btn">Hacer un Nuevo Check-in</button>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
